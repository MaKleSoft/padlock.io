<div class="device-wrapper" id="{{ .id }}">
    <div class="device {{ .type }}">
        <div class="back"></div>
        <div class="body"></div>
        <div class="body"></div>
        <div class="body"></div>
        <div class="body"></div>
        <div class="body"></div>
        <div class="body"></div>
        <div class="body"></div>
        <div class="body"></div>
        <div class="front">
            <div class="window-buttons">
                <div></div>
                <div></div>
                <div></div>
            </div>
            <div class="screen">
                <video src="{{ .video }}" playsinline muted></video>
                <!-- <img src="{{ .img }}" style="display: none" onload="console.log('loaded'); this.style.display='';"> -->
            </div>
        </div>
        </div>
</div>
<script>
(() => {
    const deviceWrapper = document.currentScript.previousElementSibling;
    const device = deviceWrapper.querySelector(".device");
    const video = deviceWrapper.querySelector("video");
    const scroller = document.scrollingElement;
    const deviceBounds = device.getBoundingClientRect();
    const scrollerHeight = scroller.offsetHeight;
    const deviceTop = deviceBounds.top + scroller.scrollTop;
    const topThreshold = Math.min(
        // Top threshold is when the middle of the device is in the upper two thirds of the screen
        deviceTop - scrollerHeight * 2 / 3,
        scroller.scrollHeight
    );
    const bottomThreshold = Math.max(
        deviceTop + deviceBounds.height - scrollerHeight * 1 / 3,
        0
    );

    let hasPlayed = false;

    video.addEventListener("playing", () => {
        device.style.animationPlayState = "running";
    });

    const scrollHandler = () => {
        if (
            !hasPlayed &&
            scroller.scrollTop > topThreshold &&
            scroller.scrollTop < bottomThreshold
        ) {
            document.removeEventListener("scroll", scrollHandler);
            hasPlayed = true;
            video.play();
        }
    };

    document.addEventListener("scroll", scrollHandler);
    window.addEventListener("load", scrollHandler);
})();
</script>
